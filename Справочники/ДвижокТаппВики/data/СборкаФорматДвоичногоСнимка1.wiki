++ Сборка Формат Двоичного Снимка1

+++Структура двоичного снимка
* todo.концепция.снимки: Надо осмотреть существующий КодДвижка и переработать описание здесь для более полного соответствия. Как по составу секций, так и по концепции.

Каждый элемент выводится как ЗаписьСнимкаСтруктуры. Формат записи фиксированный.
ЗаписьСнимкаСтруктуры содержит код ТипЗаписиСнимка (ЗаголовокСнимка, контейнер, ячейка, связь, ...) и длину.
Поля произвольной длины (строки, массивы) предваряются размером поля. Размер поля хранится int 4 байтами.
Идентификаторы ИдентификаторЯчейки и ИдентификаторСвязи хранятся 8 байтами. Если ИдентификаторСолюшена не используется, старшие 4 байта = 0.

Поскольку СтруктураСущностей из снимка может занимать много памяти, при загрузке теоретически может возникнуть недостаток памяти. Например, если каждая ячейка содержит по 1 Гб данных, то 2 таких ячейки, загруженные в память, вызовут ошибку Недостаток памяти. 
    * todo.концепция.снимки: Вопрос ОбсуждениеРазмерДанныхЯчейки надо специально прорабатывать на уровне концепции и на уровне кода.

Поскольку постоянные ячейки и связи будут и в памяти, и в таблице, получается что они дважды будут выведены в ФайлСнимка. Это необходимо для ячеек MCellBds, чтобы выводилось именно моментальное состояние всей СтруктураСущностей.

++++Структура файла двоичного снимка
Для разных типов снимков получаются разные смыслы секций.

Для ПолныйСнимокСтруктуры:
1) ЗаголовокСнимка
2) СекцияКонтейнера
3) СекцияЯчеекВПамяти
4) СекцияЯчеекВБд
5) СекцияВнешнихЯчеек - внешних относительно Солюшена
6) СекцияСвязейВПамяти
7) СекцияСвязейВБд
8) СекцияКонцаФайла

Для ЧастичныйСнимокСтруктуры:
1) ЗаголовокСнимка
2) СекцияКонтейнера
3) СекцияЯчеекВПамяти
4) СекцияЯчеекВБд
5) СекцияВнешнихЯчеек - внешних относительно ячеек, входящих в УчастокСтруктурыСущностей, для которого и делается этот частичный снимок.
6) СекцияСвязейВПамяти
7) СекцияСвязейВБд
8) СекцияКонцаФайла


+++++Зависимости порядка следования секций
* ЗаголовокСнимка должен идти первым.
* СекцияКонтейнера идет до секций ячеек и связей, так как описывает свойства солюшена. Например, наличие БД.
* Поскольку создание связи требует наличия ячеек, то сначала идут секции ячеек, а потом связей.
* Сначала идут секции из таблицы, потом из памяти.
* СекцияКонцаФайла - последняя секция файла. Она служит индикатором, который используется парсером файла снимка для завершения разбора файла.
* todo.снимок: Найти и описать упущенные зависимости порядка следования секций.

++++Типы секций
Типы секций обозначаются кодом енума ТипЗаписиСнимка, который должен быть первым байтом секции.
* ЗаголовокСнимка или шапка снимка - представлен классом MSnapshotFileInfo
* СекцияКонцаФайла - обозначает конец файла снимка.
* СекцияКонтейнера - хранит данные [Контейнер]а и НастройкиСолюшена
* СекцияЯчеекВПамяти - содержит все ячейки, загруженные в память на момент создания снимка. 
* СекцияЯчеекВБд - содержит все ячейки, существующие в БазаДанныхСолюшена на момент создания снимка.
* СекцияВнешнихЯчеек - Секция Связанных ячеек: 
    * Для ЧастичныйСнимокСтруктуры: Это список ячеек, связанных с ячейками, входящими в ЧастичныйСнимокСтруктуры. Эти ячейки должны быть только постоянными, временные ячейки должны включаться в ЧастичныйСнимокСтруктуры. Секция предназначена для проверки согласованности состояния СтруктураСущностей при загрузке ЧастичныйСнимокСтруктуры. Связи, связывающие эти ячейки с ячейками из снимка, хранятся в секциях снимка, остальные связи этих ячеек не сохраняются в снимке.
    * Для ПолныйСнимокСтруктуры сюда помещаются внешние ячейки (не входящие в данный Солюшен, но связанные с его ячейками) точно так же, как для ЧастичныйСнимокСтруктуры.
* СекцияСвязейВПамяти - содержит все связи, загруженные в память на момент создания снимка.
* СекцияСвязейВБд - содержит все связи, существующие в БазаДанныхСолюшена на момент создания снимка.
* СекцияЯчейки - содержит данные ячейки
* СекцияСвязи - содержит данные связи
Секции ячеек/связей из памяти и из БД *нельзя* объединить. Так как нужно отмечать источник: память или таблица. 
Связанные ячейки, описанные в СекцияВнешнихЯчеек, не загружать, а проверять наличие в Солюшене(Солюшенах) и одинаковость значения свойств. Если не совпадает, остановить загрузку и выдать сообщение.

+++Форматы секций - переработать
Здесь описаны форматы различных секций, для версии Тапп2.
todo.снимок: Надо поля секций привести к требованиям текущего проекта.

++++Общий формат секции
Каждая секция имеет код секции, размер секции в байтах, данные.
Описатель — ТипЗаписиСнимка, 1 байт
Размер секции  - поле 8 байт. Значение такое, чтобы, прибавив его к текущей позиции чтения файла, можно было переместиться на начало следующей секции.

Старый формат секции неудачный - данные заголовка секции и данные элементов секции защищаются одним крк кодом, который находится в заголовке секции. Надо бы одним кодом защищать заголовок, другим, в конце секции, элементы секции.
    * в смысле, перенести крк-код в конец секции? Это усложнит парсер. Если вложенные субсекции в самом конце секции, то парсер просто берет однотипные субсекции, а как только попадается другой код секции, то это и есть конец секции и начало другой секции. А если в конце секции еще будут поля, то это надо каждую секцию отдельно парсить. Это нехорошо.
    * вложенные субсекции сами защищены собственным крк-кодом. Зачем считать крк для всей секции, которая может быть размером в 10Гб? Это и долго и бесполезно.

++++Заголовок снимка
См. ЗаголовокСнимка.
Секция шапки файла содержит:
* 8 UInt64 СигнатураФайлаСнимка — установленная последовательность байт для идентификации файла снимка.
* 4 Int32 размер секции в байтах
* ? ? ВерсияПодсистемыСнимков - для поддержки разных версий структуры снимков
* 16? ВерсияДвижка — для проверки совместимости данных снимка с движком при загрузке
* 16? ВерсияСолюшена  - текущая версия солюшена
* 16? ВерсияСолюшена  - предыдущая версия солюшена - как ссылка на предыдущий файл снимка в ВетвьВерсииСолюшена
* 4 Int32 код ТипСнимка: полный снимок или частичный снимок.
* 4 Int32 ИдентификаторСолюшена для поддержки КонцепцияМультиконтейнерность 
* ? СтатистикаСнимка - значения вписать для содержимого снимка, если это ЧастичныйСнимокСтруктуры. Также использовать для оценки объема требуемой памяти.
* ? String НазваниеСолюшена — для пользователя. Ввиду переменного размера, поместить в конец шапки.
* ? String ОписаниеСолюшена — для пользователя. Ввиду переменного размера, поместить в конец шапки.
* todo.снимок: Добавить правильные свойства заголовка снимка здесь...
* 4 UInt32 контрольная сумма CRC32 всех предыдущих полей

++++Секция описания контейнера
См СекцияКонтейнера. 
* byte ТипЗаписиСнимка
* int размер секции
* НастройкиСолюшена
* todo.снимок: Добавить правильные свойства здесь...
* контрольная сумма

________________________________________
СЕКЦИЯ КОНТЕЙНЕРА  - из движка тапп231, как пример таблицы структуры
________________________________________
address |size | valuetype |description 
________________________________________
0 |1 |byte |container section descriptor
1 |4 |int32 |section size
5 |4 |int32 | container id
9 |1-хз |string | container name
|1-хз |string | container description
|8 |uint64 | state id
|1 |bool | isactive
|4 |int32 | service flag
|1 |byte | default cell mode
|4 |int32 | log detail flags
|1 |bool | log add symbolic data
|4 |int32 | log file number
|4 |int32 | database timeout
|4 |int32 | snapshot step - structure version
|2 |int16 | crc16 checksum 
________________________________________

++++Секция списка ячеек:
Для СекцияЯчеекВПамяти, СекцияЯчеекВБд, СекцияВнешнихЯчеек
* код ТипЗаписиСнимка, 1 байт
* размер секции, 8байт
* число ячеек, 4 байта
* контрольная сумма без учета секций описания ячеек
* секции описания ячеек.


СЕКЦИИ СПИСКОВ ЯЧЕЕК И СВЯЗЕЙ - одинаковый формат для всех этих секций 
________________________________________
address |size | valuetype |description 
________________________________________
0 |1 |byte |section descriptor
1 |8 |int64 |section size with subitems
9 |4 |int32 |num of subitems
13 |2 |int16 |crc16 checksum of previous two fields 
15 |??? | - |subitem sections
Это заголовок секции. Далее идут субитемы - секции ячеек или связей. Общая длина секции записывается после их вывода, затем высчитывается и записывается контрольная сумма. Контрольная сумма не считает субитемы - у них свои контрольные суммы есть.

++++Секция описания ячейки:
Для СекцияЯчейки - для Тапп2
1)код ТипЗаписиСнимка 1б
2)длина записи, байт 4б
3)ид ячейки 8б
4)длина строки имени 1-2б
5)символы строки имени
6)ид stateID 8б
7)ид typeID 8б
8)ид valueTypeID 8б
9)длина массива данных, байт 4б
10) массив данных
11) длина строки описания 1-2б
12) строка описания
13) isActive 1б
14) Creatime 8b
15) moditime 8b
16) readonly 1b
17) serviceflag 4b
18) checksum 2byte – контрольная сумма секции
19) 

________________________________________
СЕКЦИЯ ЯЧЕЙКИ - секция данных ячейки 
________________________________________

address |size | valuetype |description 
________________________________________
0 |1 |byte |section descriptor 
.................................
??? |2 |int16 | crc16 checksum 
________________________________________


++++Секция списка связей
Для СекцияСвязейВПамяти, СекцияСвязейВБд
* код ТипЗаписиСнимка, 1 байт
* размер секции, 8байт
* число секций связей, 4 байта
* секции описания связей.
* контрольная сумма без учета секций описания связей

СЕКЦИИ СПИСКОВ ЯЧЕЕК И СВЯЗЕЙ - одинаковый формат для всех этих секций 
________________________________________
address |size | valuetype |description 
________________________________________
0 |1 |byte |section descriptor
1 |8 |int64 |section size with subitems
9 |4 |int32 |num of subitems
13 |2 |int16 |crc16 checksum of previous two fields 
15 |??? | - |subitem sections
Это заголовок секции. Далее идут субитемы - секции ячеек или связей. Общая длина секции записывается после их вывода, затем высчитывается и записывается контрольная сумма. Контрольная сумма не считает субитемы - у них свои контрольные суммы есть.

++++Секция описания связи
Для СекцияСвязи - для Тапп2
* byte код ТипЗаписиСнимка 1б
* int длина записи, байт 4б — длина записи без заголовка и текущего поля, т. е. добавляешь эту длину к позиции чтения и попадаешь на первый байт следующей секции.
* mid downCellId 8b
* mid upCellId 8b
* mid axisId 8b
* mid stateId 8b
* bool isActive 1b
* int serviceFlag 4b 
* int linkId 4b — нужен для отличения временной связи от постоянной. При десериализации значение заменяется на правильное.
* string description 
* checksum 2byte – контрольная сумма секции

СЕКЦИЯ СВЯЗИ - секция данных связи 
________________________________________

address |size | valuetype |description 
________________________________________
0 |1 |byte |section descriptor 
................................
??? |2 |int16 | crc16 checksum 

++++Секция конца файла
Для СекцияКонцаФайла
* byte код ТипЗаписиСнимка 1б — признак конца файла



