++ Сборка Номер Шага Солюшена1

++++Номер шага солюшена
* Когда создается новый ПолныйСнимокСтруктуры, ВерсияСолюшена должна измениться.
* ПолныйСнимокСтруктуры фиксирует предыдущие изменения в СтруктураСущностей. Он не может быть создан внутри метода или любой ТранзакцияСолюшена. Он представляет собой точку быстрого перехода к некоторой стадии жизни солюшена.
* НомерШагаСолюшена - инт32 ранее назывался шаг снимка, ШагБазы, НомерШагаСолюшена - последовательно увеличивается от снимка к снимку.
    * Сейчас входит в состав ВерсияСолюшена, поэтому мог бы не храниться в НастройкиСолюшена как отдельное поле.
    * Когда создается новый снимок, ВерсияСолюшена должна измениться?
        * Если да, то как сравнивать две ВерсияСолюшена?
            * Для чего нужно сравнивать две версии солюшена?
        * Если нет, то когда же тогда ВерсияСолюшена должна измениться?
            * При загрузке из снимка? А до этого оставаться старой?
    * А если ТранзакцияСолюшена, внутри которой создается ПолныйСнимокСтруктуры, отменена, то как быть?
        * полный снимок не должен быть создан внутри ТранзакцияСолюшена. Он выше этого. Он - фундаментальное свойство системы. Хм.
    * А если ТранзакцияСолюшена, перед которой был создан ПолныйСнимокСтруктуры, отменена, что делать?
        * Ничего, НомерШагаСолюшена не изменился же.
    * А если ТранзакцияСолюшена, после которой был создан ПолныйСнимокСтруктуры, отменена, что делать?
        * Это получается разветвление версий солюшена. Транзакции могут быть откачены к любой точке состояния на всем жизненном цикле солюшена, так? Если есть файлы лога на весь этот участок. Следовательно, откат к произвольной точке в дальнейшем порождает новую ветвь развития солюшена ВетвьВерсииСолюшена. Тогда в НомерШагаСолюшена хранится значение, соответствующее текущей точке (в прошлом). И новые версии ПолныйСнимокСтруктуры этого солюшена получат уже занятые номера и будут конфликтовать по именам с файлами из другой ВетвьВерсииСолюшена.
        * А главное, переходы по этим ветвям не будут простыми. В старом одноветвевом принципе легко было перейти к предыдущему или следующему ПолныйСнимокСтруктуры, просто по его номеру.
        * Как назначать НомерШагаСолюшена для таких разных ветвей?
            А) брать следующий свободный НомерШагаСолюшена.
                * Нарушается последовательность нумерации версий. Тогда нельзя точно сказать, какой ВетвьВерсииСолюшена принадлежит этот снимок, и какой НомерШагаСолюшена был у предыдущего снимка.
            Б) Ввести в ВерсияСолюшена еще номер ветви, чтобы нумеровать не только по НомерШагаСолюшена, но и еще по номеру ветви. 
                * Это позволит отслеживать ПолныйСнимокСтруктуры внутри ВетвьВерсииСолюшена. Но не позволит выходить из ветви в родительскую ВетвьВерсииСолюшена, если параллельно такой существует еще одна, поскольку их номер ветви затирается новым номером ветви.
                * Можно ввести в ПолныйСнимокСтруктуры еще старый НомерШагаСолюшена от предыдущего ПолныйСнимокСтруктуры.  Это легко, просто надо в дополнительное поле вписывать старую ВерсияСолюшена до ее инкрементации. Это образует дерево версий солюшена от позднего к раннему, но двигаться по нему от корня к ветвям нельзя. Поскольку нельзя перезаписывать старые ПолныйСнимокСтруктуры, чтобы прописать в них ВерсияСолюшена как ссылку на более новый снимок.
            * В общем, с этими ВетвьВерсииСолюшена проблема: из них надо сформировать дерево, с возможностью передвигаться от корня к листьям. Но это невозможно хронологически. А всякие там дополнительные поля не нужны, если есть ссылки на предыдущий-следующий файл снимка. Тогда можно просто Брать следующий свободный НомерШагаСолюшена, а ветви строить ссылками предыдущий - следующий снимок.
            * Можно использовать только предыдущую ВерсияСолюшена ПолныйСнимокСтруктуры в файле снимка, а строить дерево версий в памяти, перебором всех существующих снимков ПолныйСнимокСтруктуры. Строить или где-то в момент инициализации менеджера снимков, или при необходимости в таком дереве, отдельным механизмом-енумератором.     
        * А КонцепцияЛога как будет работать с ветвями ВетвьВерсииСолюшена?
            * Сегодня Загрузили Версию1.1.1, поработали, создали Версию1.1.2. Потом загрузили Версию 1.4.7, сохранили Версию 1.4.8. Потом загрузили версию 1.1.2, поработали, не сохранили. Потому что результат не понравился. Потом загрузили Версию 1.4.8, поработали, сохранили Версию 1.4.9.
            * Вот это все лог должен будет корректно разобрать, отличить и при необходимости откатить изменения обратно. Это выглядит как огромная куча работы, которую я должен разгрести, чтобы разработать поддержку этих ВетвьВерсииСолюшена.
            * Мне уже хочется это все отложить на будущее. Возможно, на следующий релиз, а то и еще дальше. Сейчас это слишком сложно. Может быть, после релиза и опыта работы, будет ясно, что и как и зачем делать.
* Если упрощенно, то можно хранить НомерШагаСолюшена в ВерсияСолюшена и инкрементировать его перед сохранением ФайлПолногоСнимка.
    * И в МенеджерСолюшена получать значение НомерШагаСолюшена и ВерсияСолюшена из НастройкиСолюшена из объекта ФайлСолюшена?   
    * Так ФайлПолногоСнимка получается что-то вроде стадии жизненного цикла Солюшена, точки между ТранзакцияСолюшена. 
        * И тогда можно логи синхронизировать с этими моментами и как-то это использовать?
* а как тогда определять свободный НомерШагаСолюшена для нового снимка?
    * А) искать наибольший свободный и инкрементировать его. Это значит - перебрать все файлы снимков.
        * Тут может оказаться конфликт одинаковых ВерсияДвижка из-за того, что самый свежий ПолныйСнимокСтруктуры был перемещен в собственный жизненный цикл.
            * Такое должен разруливать РегистраторСолюшенов. Если солюшен зажил собственной жизнью, у него должен быть другой ИдентификаторСолюшена. Хотя это надо переписать все идентификаторы ячеек и связей.
            * todo: Вот кстати функция Контейнера выявилась: *сменить идентификатор солюшена*, когда он создается как новый из ПолныйСнимокСтруктуры. (А как будут сменяться *идентификаторы солюшена* в связанных солюшенах?)
            * todo: представить, как вообще будут создаваться солюшены: с нуля; импортом УчастокСтруктурыСущностей из существующего солюшена; как-то еще? С учетом КонцепцияМультиконтейнерность.   
    * Б) завести и хранить отдельно НомерШагаСолюшена, так он никогда не будет конфликтовать.
        * а где хранить, если солюшен перезаписывается из файла  полного снимка?
        * Надо хранить его вне солюшена. На РегистраторСолюшенов? А если его нет в одноконтейнерной версии движка? Неудобно.        
+++++Выводы 
* Отказаться от поддержки ВетвьВерсииСолюшена не получится. В моем бардаке образование ветвей ВетвьВерсииСолюшена неизбежно. И если их игнорировать, они все запутают.
* Это огромная куча для анализа, и это все я отложил, как минимум, на следующий релиз.
* В ПолныйСнимокСтруктуры надо хранить старую и новую ВерсияСолюшена. Новая - отражает новую версию, с новым НомерШагаСолюшена. Старая - обеспечивает переход к предыдущему ПолныйСнимокСтруктуры и построение ДеревоВерсийСолюшена. Это надо заложить уже сейчас, остальное добавить после релиза обновлением.
* Получение нового НомерШагаСолюшена должно выполняться как (максимум из существующих+1). Это предполагает полный перебор всех имеющихся ПолныйСнимокСтруктуры в момент создания нового снимка.  Это надо заложить уже сейчас, остальное добавить после релиза обновлением.
* Переход между ПолныйСнимокСтруктуры нужно делать с помошью ДеревоВерсийСолюшена. 
* ДеревоВерсийСолюшена надо реализовать неким отдельным объектом, создаваемым при необходимости, а не при старте солюшена.
* ДеревоВерсийСолюшена создается путем перебора всех ПолныйСнимокСтруктуры. Поскольку не все эти файлы будут доступны, дерево может оказаться совсем не деревом, а набором отдельных ВетвьВерсииСолюшена. С пропусками в ветвях.
* Переделать сущности:
    * done: Убрать из НастройкиСолюшена отдельное поле НомерШагаСолюшена.
    * done: Добавить в ЗаголовокСнимка поля [//ЗаголовокСнимка/ПолеПредыдущаяВерсияСолюшена] и [//ЗаголовокСнимка/ПолеТекущаяВерсияСолюшена]
    

 



    